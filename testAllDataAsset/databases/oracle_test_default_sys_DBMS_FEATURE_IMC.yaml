name: DBMS_FEATURE_IMC
fullyQualifiedName: oracle_test.default.sys.DBMS_FEATURE_IMC
storedProcedureCode:
  language: SQL
  code: |2-
        feature_info    OUT CLOB)
    procedure DBMS_FEATURE_IMC(
        feature_boolean OUT NUMBER,
        aux_count       OUT NUMBER,
    AS
        feature_usage               varchar2(1000);
        num_tab                     number;
        num_tab_part                number;
        num_tab_subpart             number;
        num_tab_cc                  number;
        num_tab_part_cc             number;
        num_segs                    number;
        inmemory_size_value         number;
        cell_level_value            number;

    BEGIN
        feature_boolean             := 0;
        aux_count                   := 0;
        inmemory_size_value         := 0;
        cell_level_value            := 0;

        -- check if any segments are enabled for in-memory
        execute immediate
           'select count(*) from dba_tables where ' ||
           'inmemory_compression is not null and ' ||
           'not (tablespace_name in (''SYSTEM'', ''SYSAUX'') ' ||
           'and owner like ''SYS'')'
        into num_tab;

        execute immediate
           'select count(*) from dba_tab_partitions where ' ||
           'inmemory_compression is not null and ' ||
           'not (tablespace_name in (''SYSTEM'', ''SYSAUX'') ' ||
           'and table_owner like ''SYS'') and table_name ' ||
           'not like ''BIN$%'''
        into num_tab_part;

        execute immediate
           'select count(*) from dba_tab_subpartitions where ' ||
           'inmemory_compression is not null and ' ||
           'not (tablespace_name in (''SYSTEM'', ''SYSAUX'') ' ||
           'and table_owner like ''SYS'') and table_name ' ||
           'not like ''BIN$%'''
        into num_tab_subpart;

        -- check if any segments were enabled for cellmemory
        -- note some tables may show up twice as in-memory and cellmemory
        execute immediate
           'select count(*) from dba_tables where ' ||
           'cellmemory like ''MEMCOMPRESS%'' and ' ||
           'not (tablespace_name in (''SYSTEM'', ''SYSAUX'') ' ||
           'and owner like ''SYS'')'
        into num_tab_cc;

        execute immediate
           'select count(*) from dba_tab_partitions where ' ||
           'cellmemory like ''MEMCOMPRESS%'' and ' ||
           'not (tablespace_name in (''SYSTEM'', ''SYSAUX'') ' ||
           'and table_owner like ''SYS'') and table_name ' ||
           'not like ''BIN$%'''
        into num_tab_part_cc;

        -- check if any segments are actually in-memory
        execute immediate
           'select count(*) from gv$im_segments_detail where ' ||
           'segtype=0'
        into num_segs;

        -- check the value of the parameter "inmemory_size" from
        -- all instances, excluding instances where base level mode is enabled
        execute immediate
             '(select value, inst_id from gv$parameter where ' ||
           'select nvl(max(A.value),0) from ' ||
             '(select value, inst_id from gv$parameter where ' ||
               'name=''inmemory_size'') A, ' ||
               'name=''inmemory_force'') B ' ||
           'where A.inst_id = B.inst_id and upper(B.value) != ''BASE_LEVEL'''
        into inmemory_size_value;

        execute immediate
           'select count(*) from gv$parameter where ' ||
             'upper(value) = ''CELLMEMORY_LEVEL'''
        into cell_level_value;

        --Summary
        feature_usage :=
            ' In-Memory Column Store Feature Usage: ' ||
                    'In-Memory Column Store Tables: ' ||
                      to_char(num_tab) ||
            ', ' || 'In-Memory Column Store Table Partitions: ' ||
                      to_char(num_tab_part) ||
            ', ' || 'In-Memory Column Store Table Subpartitions: ' ||
                      to_char(num_tab_subpart) ||
            ', ' || 'Total In-Memory Column Store Segments Populated: ' ||
                      to_char(num_segs) ||
            ', ' || 'Cellcache Column Store Tables: ' ||
                      to_char(num_tab_cc) ||
            ', ' || 'Cellcache Column Store Table Partitions: ' ||
                      to_char(num_tab_part_cc) ||
            ', ' || 'CellMemory Level: ' ||
                      to_char(cell_level_value);

        -- Do we want to report feature use for cell level
         if (((num_tab + num_tab_part + num_tab_subpart + num_segs > 0)
             AND (inmemory_size_value > 0))
        OR  (num_tab_cc + num_tab_part_cc > 0)
        OR  (cell_level_value > 0))
            then
          feature_boolean := 1;
          feature_info := to_clob(feature_usage);
        else
          feature_boolean := 0;
          feature_info := to_clob('In-Memory Column Store Not Detected');
        end if;
    END;
dataProducts: []
storedProcedureType: StoredProcedure
databaseSchema:
  id: a11e2293-c7ca-4d3a-9e0f-ebcfa337159d
  type: databaseSchema
  name: sys
  fullyQualifiedName: oracle_test.default.sys
  displayName: sys
  deleted: false
database:
  id: 635299d9-9c3d-4ccc-98ff-dfb95889d8d6
  type: database
  name: default
  fullyQualifiedName: oracle_test.default
  displayName: default
  deleted: false
service:
  id: 81062063-d522-406b-92a3-ccad1f68f1ad
  type: databaseService
  name: oracle_test
  fullyQualifiedName: oracle_test
  displayName: oracle_test
  deleted: false
serviceType: Oracle
owners: []
tags: []
domains: []
sourceHash: 0b6831ac1e6efeb853b7c0d5e73c4501
processedLineage: false
entityStatus: Approved
